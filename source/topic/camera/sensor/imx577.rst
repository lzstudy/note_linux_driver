imx577
===========

1 调试思路
--------------

- imx577时钟系统的配置, 用于基本传输和帧率计算等
- 图像参数配置, 比如格式(raw10/raw12等), lane数量配置
- 图像模式设置, FULL、binning、HDR
- 图像显示区域配置(决定fov)
- 图像输出分辨率配置
- 曝光和增益配置
- 3A和其他图像参数配置

2 时钟相关配置
-----------------

.. image:: clock.jpg

2.1 输入时钟设置
*****************

传感器的输入时钟要通知寄存器, 通过下面寄存器设置

======== ======================== ==============
寄存器   描述                     限制/范围
0x0136   时钟的值                 6 - 27
======== ======================== ==============

2.2 PLL模式选择
*****************

imx577内置两个PLL, 一个用于图像处理时钟IVTCK, 一个用MIPI时钟IOPCK, 可以配置两种模式, 
系统也推荐使用单PLL模式, 我目前使用都是单PLL模式。

- 当配置单PLL模式时, IVTCK = IOPCK, 此时只配置IVTCK相关寄存器即可, 
- 采用双PLL模式, 可以更灵活的配置MIPI传输配置, 因为有独立的寄存器配置IOPCK, 不过一般用处不大,


======== ======================== ==============
寄存器   描述                     限制/范围
0x0310   0表示单PLL, 1表示双PLL   0/1
======== ======================== ==============

2.3 IVTPCK和IOPCK
*******************

IVTPCK是对输入时钟INCK 分频 + 倍频后的输出时钟, 用于处理图像帧率计算等, 范围1800 - 2100M, 
另外由于采用单PLL模式, IVTPCK = IOPCK

======== ======================== ==============
寄存器   描述                     限制/范围
0x0305   对INCK分频               1 - 4
0x0306/7 对INCK倍频               150 - 350
======== ======================== ==============

.. note:: 
    
    将来在调整帧率时, 一般通过调整0x0306/7 倍频寄存器进行调整

2.4 IVTPXCK计算
****************

IVTPXCK用于帧率计算, 只能为IVTCK的1/10或1/20 

======== ======================== ==============
寄存器   描述                     限制/范围
0x0301   初步分频                 固定为5
0x0303   设置分频                 2/4
======== ======================== ==============

2.5 IOPPXCK计算
*****************

IOPXXCK用于MIPI时钟, 只能为IOPCK的1/8或1/48

======== ======================== ============================
寄存器   描述                     限制/范围
0x0309   初步分频                 8/10/12, 对于RAW10固定为10
0x030B   设置分频                 1/2/4
======== ======================== ============================


3 图像参数设置
------------------

3.1 设置图像格式
*******************

imx577支持raw8/raw10/raw12

======== ======================== ============================
寄存器   描述                     限制/范围
0x0112   格式高位                 0A0A - RAW10, 0C0C - RAW12
0x0113   格式低位                 
======== ======================== ============================

3.2 lane数量设置
*****************

imx577支持2lane/4lane

======== ======================== ============================
寄存器   描述                     限制/范围
0x0114   lane数量设置             1 - 2lane, 3 - 4lane              
======== ======================== ============================

3.3 窗口模式
**************

还不清楚实用场景, 目前选择0 - 传统方式

======== ======================== =============================
寄存器   描述                     限制/范围
0x3F59   是否开启窗口模式         0 - 传统方式, 1 - window模式     
======== ======================== =============================

4 图像模式设置
------------------

IMX577支持3种图像模式, 全分辨率、Binning、HDR, 选择相应的模式, 只需配置对应的寄存器, 
其他模式的寄存器可以不设置

4.1 全分辨率模式
*******************

4.2 Binning模式
*****************

4.3 HDR模式
**************

5 图像显示区域设置
---------------------



3 重要参数计算
-----------------

1 帧率计算
------------

fsp = pixel_rate / pixel_per_frame

1.1 pixel_rate
*****************

.. code-block:: c

    # 1 像素速率
    pixel_rate = IVTPXCK * 4
               = IVTCK / 10 * 4
               = (INCK * PRE_DIVIDE * PLL_MPLTIPLE) / 10 * 4
               = (INCK * (1 / IVT_PREPLLCK_DIV) * IVT_PLL_MPY) / 10 * 4

               = (24 * (1 / 2) * 175) / 10 * 4
               = 840


.. note:: 
    
    - INCK 寄存器地址 0136, 范围6 - 27
    - IVT_PREPLLCK_DIV 寄存器地址 0305, 范围 1 - 4
    - IVT_PLL_MPY 寄存器地址 0306 0307, 范围100 - 350


1.2 pixel_per_frame
***********************

pixel_per_frame = FRM_LENGTH_LINES x LINE_LENGTH_PCK

                = 0x1B58 * 0x0FA4 = 28,028,000

.. note:: 
    
    - FRM_LENGTH_LINES 寄存器地址 0x0340
    - LINE_LENGTH_PCK 寄存器地址 0x0342
